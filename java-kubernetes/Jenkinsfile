pipeline {
    agent any
    parameters {
        string(name: 'app_name', description: 'The name of the app to be created')
        string(name: 'git_email', description: 'The email for the git repo')
        string(name: 'git_user', description: 'The name of the username for the git repo')
        string(name: 'git_password', description: 'The name of the password for the git repo')
        string(name: 'jenkins_job_name', description: 'The name of the jenkins job')
        string(name: 'jenkins_job_parameters', description: 'The parameters for the jenkins job seperated by commas')
    }
    stages {
        stage('Setup App Name') {
            steps {
               dir("java-kubernetes/app"){
                  sh 'sed -i "s/@app_name@/$app_name/g" pom.xml'
               }
               dir("java-kubernetes/deploy/config"){
                  sh 'sed -i "s/@app_name@/$app_name/g" app.json'
               }
            }
        }
        stage('Setup Git Repository') {
           steps {
              dir("java-kubernetes"){
                 sh 'chmod +x create_repo.sh'
                 sh 'sed -i "s/@git_user@/$git_user/g" create_repo.sh'
                 sh 'sed -i "s/@git_password@/$git_password/g" create_repo.sh'
                 sh 'sed -i "s/@app_name@/$app_name/g" create_repo.sh'
                 sh './create_repo.sh'
                 sh 'git config --global user.email "$git_email"'
                 sh 'git config --global user.name "$git_user"'
                 sh 'echo "# $app_name" >> README.md'
                 sh 'git init'
                 sh 'git remote set-url origin https://$git_user:$git_password@github.com/kriad85/$app_name.git'
                 sh 'git add README.md'
                 sh 'git add app'
                 sh 'git add deploy'
                 sh 'git add infra'
                 sh 'git add jenkins'
                 sh 'git commit -m "add of project"'
                 sh 'git push origin master'
              }
           }
        }
        stage('Setup Jenkins Job') {
           steps {
               build job: 'Seed_JOB', parameters: [[$class: 'StringParameterValue', name: 'job', value: "${params.jenkins_job_name}"],[$class: 'StringParameterValue', name: 'job_parameters', value: "${params.jenkins_job_parameters}"], propagate: true	
           }
        }
    }
}
